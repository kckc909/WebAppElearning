// ====== LEARNING PLATFORM DATABASE SCHEMA ======
// Generated from Prisma Schema
// Use at: https://dbdiagram.io/

// ====== BẢNG TÀI KHOẢN ======
Table accounts {
  id int [pk, increment]
  full_name varchar(255) [not null]
  email varchar(255) [unique, not null]
  password_hash varchar(255) [not null]
  avatar_url text
  role enum('SUPER_ADMIN','ADMIN','INSTRUCTOR','STUDENT') [default: 'STUDENT']
  status int [default: 1]
  created_at datetime [default: `CURRENT_TIMESTAMP`]
  updated_at datetime [default: `CURRENT_TIMESTAMP`]
  username varchar(100) [unique]
  deleted_at datetime
  email_verified boolean [default: false]
  email_verified_at datetime
  last_login_at datetime
  
  indexes {
    email
    role
    status
  }
}

// ====== BẢNG DANH MỤC KHÓA HỌC ======
Table course_categories {
  id int [pk, increment]
  name varchar(255) [not null]
  slug varchar(255) [unique, not null]
  icon varchar(100)
  description text
  parent_id int [ref: > course_categories.id]
  created_at datetime [default: `CURRENT_TIMESTAMP`]
  is_active boolean [default: true]
  order_index int [default: 0]
  updated_at datetime [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    parent_id
    slug
  }
}

// ====== BẢNG KHÓA HỌC ======
Table courses {
  id int [pk, increment]
  instructor_id int [not null, ref: > accounts.id]
  category_id int [ref: > course_categories.id]
  title varchar(500) [not null]
  short_description text
  description longtext
  level enum('BEGINNER','INTERMEDIATE','ADVANCED','ALL_LEVELS') [default: 'ALL_LEVELS']
  language varchar(10) [default: 'vi']
  price decimal(10,2) [default: 0.00]
  discount_price decimal(10,2) [default: 0.00]
  status enum('DRAFT','PENDING','PUBLISHED','REJECTED','ARCHIVED') [default: 'DRAFT']
  created_at datetime [default: `CURRENT_TIMESTAMP`]
  updated_at datetime [default: `CURRENT_TIMESTAMP`]
  average_rating decimal(3,2) [default: 0.00]
  deleted_at datetime
  is_featured boolean [default: false]
  preview_video_url text
  published_at datetime
  slug varchar(500) [unique, not null]
  thumbnail_url text
  total_duration int [default: 0]
  total_lessons int [default: 0]
  total_reviews int [default: 0]
  total_students int [default: 0]
  requirements json
  what_you_will_learn json
  target_audience json
  revenue decimal(15,2) [default: 0.00]
  rejection_reason text
  reviewed_at datetime
  reviewed_by int
  submitted_at datetime
  certificate_threshold int [default: 100]
  
  indexes {
    category_id
    instructor_id
    slug
    status
    (title, short_description) [type: fulltext]
  }
}

// ====== BẢNG PHẦN KHÓA HỌC ======
Table course_sections {
  id int [pk, increment]
  course_id int [not null, ref: > courses.id]
  title varchar(255) [not null]
  order_index int [default: 0]
  created_at datetime [default: `CURRENT_TIMESTAMP`]
  description text
  updated_at datetime [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    course_id
    order_index
  }
}

// ====== BẢNG BÀI HỌC ======
Table course_lessons {
  id int [pk, increment]
  section_id int [ref: > course_sections.id]
  title varchar(500) [not null]
  order_index int [default: 0]
  course_id int [not null]
  created_at datetime [default: `CURRENT_TIMESTAMP`]
  current_version int [default: 1]
  description text
  duration int [default: 0]
  is_preview boolean [default: false]
  published_at datetime
  status varchar(20) [default: 'draft']
  updated_at datetime [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    course_id
    section_id
    status
  }
}

// ====== BẢNG PHIÊN BẢN BÀI HỌC ======
Table lesson_versions {
  id int [pk, increment]
  lesson_id int [not null, ref: > course_lessons.id]
  version int [not null]
  layout_type varchar(50) [not null]
  layout_config json
  metadata json
  status varchar(20) [default: 'draft']
  created_by int
  created_at datetime [default: `CURRENT_TIMESTAMP`]
  published_at datetime
  
  indexes {
    lesson_id
    status
    (lesson_id, version) [unique]
  }
}

// ====== BẢNG TÀI NGUYÊN BÀI HỌC ======
Table lesson_assets {
  id int [pk, increment]
  lesson_id int [not null]
  lesson_version_id int [not null, ref: > lesson_versions.id]
  type varchar(20) [not null]
  filename varchar(255) [not null]
  url text [not null]
  preview_url text
  file_size bigint
  mime_type varchar(100)
  uploaded_by int
  uploaded_at datetime [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    lesson_id
    lesson_version_id
  }
}

// ====== BẢNG KHỐI NỘI DUNG BÀI HỌC ======
Table lesson_blocks {
  id int [pk, increment]
  lesson_version_id int [not null, ref: > lesson_versions.id]
  slot_id varchar(50) [not null]
  type varchar(50) [not null]
  order_index int [default: 0]
  content json
  settings json
  created_at datetime [default: `CURRENT_TIMESTAMP`]
  updated_at datetime [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    lesson_version_id
    slot_id
  }
}

// ====== BẢNG BỐ CỤC BÀI HỌC ======
Table lesson_layouts {
  id int [pk, increment]
  lesson_version_id int [not null, ref: > lesson_versions.id]
  layout_type varchar(50) [not null]
  slots json [not null]
  config json
  
  indexes {
    lesson_version_id
  }
}

// ====== BẢNG ĐĂNG KÝ KHÓA HỌC ======
Table course_enrollments {
  id int [pk, increment]
  course_id int [not null, ref: > courses.id]
  student_id int [not null, ref: > accounts.id]
  enrolled_at datetime [default: `CURRENT_TIMESTAMP`]
  progress int [default: 0]
  status varchar(20) [default: 'active']
  completed_at datetime
  last_accessed_at datetime
  
  indexes {
    course_id
    status
    student_id
    (student_id, course_id) [unique]
  }
}

// ====== BẢNG TIẾN ĐỘ BÀI HỌC ======
Table lesson_progress {
  id int [pk, increment]
  enrollment_id int [not null, ref: > course_enrollments.id]
  lesson_id int [not null, ref: > course_lessons.id]
  is_completed boolean [default: false]
  progress int [default: 0]
  time_spent int [default: 0]
  last_position int [default: 0]
  completed_at datetime
  last_accessed_at datetime
  
  indexes {
    enrollment_id
    lesson_id
    (enrollment_id, lesson_id) [unique]
  }
}

// ====== BẢNG ĐÁNH GIÁ KHÓA HỌC ======
Table course_reviews {
  id int [pk, increment]
  course_id int [not null, ref: > courses.id]
  student_id int [not null, ref: > accounts.id]
  rating int [not null]
  comment text
  created_at datetime [default: `CURRENT_TIMESTAMP`]
  helpful_count int [default: 0]
  is_public boolean [default: true]
  updated_at datetime [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    course_id
    rating
    student_id
    (course_id, student_id) [unique]
  }
}

// ====== BẢNG LỚP HỌC ======
Table classes {
  id int [pk, increment]
  course_id int [not null, ref: > courses.id]
  instructor_id int [not null, ref: > accounts.id]
  description text
  start_date date
  end_date date
  max_students int [default: 30]
  schedule json
  status varchar(20) [default: 'upcoming']
  created_at datetime [default: `CURRENT_TIMESTAMP`]
  current_students int [default: 0]
  name varchar(255) [not null]
  updated_at datetime [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    course_id
    instructor_id
    status
  }
}

// ====== BẢNG HỌC VIÊN LỚP HỌC ======
Table class_students {
  id int [pk, increment]
  class_id int [not null, ref: > classes.id]
  student_id int [not null, ref: > accounts.id]
  status varchar(20) [default: 'active']
  enrolled_at datetime [default: `CURRENT_TIMESTAMP`]
  final_grade decimal(5,2)
  
  indexes {
    class_id
    student_id
    (class_id, student_id) [unique]
  }
}

// ====== BẢNG LỊCH LỚP HỌC ======
Table class_calendar {
  id int [pk, increment]
  class_id int [not null, ref: > classes.id]
  title varchar(255) [not null]
  description text
  start_time varchar(10) [not null]
  end_time varchar(10) [not null]
  created_at datetime [default: `CURRENT_TIMESTAMP`]
  meeting_url text
  session_date date [not null]
  status varchar(20) [default: 'scheduled']
  updated_at datetime [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    class_id
    session_date
    status
  }
}

// ====== BẢNG BÀI TẬP LỚP HỌC ======
Table class_assignments {
  id int [pk, increment]
  class_id int [not null, ref: > classes.id]
  title varchar(255) [not null]
  description text
  file_url text
  due_date datetime
  created_at datetime [default: `CURRENT_TIMESTAMP`]
  max_score int [default: 100]
  
  indexes {
    class_id
    due_date
  }
}

// ====== BẢNG NỘP BÀI TẬP ======
Table class_submissions {
  id int [pk, increment]
  assignment_id int [not null, ref: > class_assignments.id]
  student_id int [not null]
  submission_url text
  submitted_at datetime [default: `CURRENT_TIMESTAMP`]
  grade decimal(5,2)
  feedback text
  
  indexes {
    assignment_id
    student_id
  }
}

// ====== BẢNG TÀI LIỆU LỚP HỌC ======
Table class_materials {
  id int [pk, increment]
  class_id int [not null, ref: > classes.id]
  title varchar(255) [not null]
  description text
  file_url text [not null]
  uploaded_at datetime [default: `CURRENT_TIMESTAMP`]
  file_size bigint
  file_type varchar(50)
  uploaded_by int
  
  indexes {
    class_id
  }
}

// ====== BẢNG BÀI KIỂM TRA LỚP HỌC ======
Table class_exams {
  id int [pk, increment]
  class_id int [not null, ref: > classes.id]
  title varchar(255) [not null]
  exam_type varchar(20) [default: 'QUIZ']
  total_score decimal(5,2) [not null]
  created_at datetime [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    class_id
  }
}

// ====== BẢNG KẾT QUẢ KIỂM TRA ======
Table class_exam_results {
  id int [pk, increment]
  exam_id int [not null, ref: > class_exams.id]
  student_id int [not null]
  score decimal(5,2)
  feedback text
  graded_at datetime [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    exam_id
    student_id
  }
}

// ====== BẢNG CHỨNG CHỈ ======
Table certificates {
  id int [pk, increment]
  student_id int [not null, ref: > accounts.id]
  course_id int [not null, ref: > courses.id]
  certificate_code varchar(100) [unique, not null]
  issued_at datetime [default: `CURRENT_TIMESTAMP`]
  certificate_url text
  verification_url text
  
  indexes {
    certificate_code
    course_id
    student_id
    (student_id, course_id) [unique]
  }
}

// ====== BẢNG GIỎ HÀNG ======
Table carts {
  id int [pk, increment]
  user_id int [unique, not null, ref: > accounts.id]
  created_at datetime [default: `CURRENT_TIMESTAMP`]
  updated_at datetime [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    user_id
  }
}

// ====== BẢNG MỤC GIỎ HÀNG ======
Table cart_items {
  id int [pk, increment]
  cart_id int [not null, ref: > carts.id]
  course_id int [not null, ref: > courses.id]
  added_at datetime [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    cart_id
    course_id
    (cart_id, course_id) [unique]
  }
}

// ====== BẢNG HÓA ĐƠN ======
Table invoices {
  id int [pk, increment]
  invoice_number varchar(100) [unique, not null]
  user_id int [not null, ref: > accounts.id]
  total_amount decimal(10,2) [not null]
  subtotal decimal(10,2) [not null]
  discount decimal(10,2) [default: 0]
  tax decimal(10,2) [default: 0]
  billing_info json
  payment_method varchar(50) [not null]
  status varchar(20) [default: 'paid']
  issued_at datetime [default: `CURRENT_TIMESTAMP`]
  due_date datetime
  paid_at datetime
  invoice_url text
  notes text
  
  indexes {
    user_id
    invoice_number
    status
    issued_at
  }
}

// ====== BẢNG CHI TIẾT HÓA ĐƠN ======
Table invoice_details {
  id int [pk, increment]
  invoice_id int [not null, ref: > invoices.id]
  user_id int [not null, ref: > accounts.id]
  course_id int [ref: > courses.id]
  amount decimal(10,2) [not null]
  method_id int [ref: > payment_methods.id]
  transaction_code varchar(100) [unique, not null]
  status varchar(20) [default: 'pending']
  created_at datetime [default: `CURRENT_TIMESTAMP`]
  completed_at datetime
  payment_data json
  
  indexes {
    invoice_id
    course_id
    method_id
    status
    transaction_code
    user_id
  }
}

// ====== BẢNG PHƯƠNG THỨC THANH TOÁN ======
Table payment_methods {
  id int [pk, increment]
  method_name varchar(100) [not null]
  provider varchar(100)
  is_active boolean [default: true]
  config json
  created_at datetime [default: `CURRENT_TIMESTAMP`]
  updated_at datetime [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    is_active
  }
}

// ====== BẢNG THANH TOÁN CHO GIẢNG VIÊN ======
Table payouts {
  id int [pk, increment]
  instructor_id int [not null, ref: > accounts.id]
  amount decimal(10,2) [not null]
  status varchar(20) [default: 'pending']
  paid_at datetime
  bank_info json
  created_at datetime [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    instructor_id
    status
  }
}

// ====== BẢNG XÁC MINH GIẢNG VIÊN ======
Table instructor_verifications {
  id int [pk, increment]
  user_id int [not null, ref: > accounts.id]
  experience text
  education text
  documents_url text
  status int [default: 0]
  created_at datetime [default: `CURRENT_TIMESTAMP`]
  rejection_reason text
  reviewed_at datetime
  reviewed_by int
  updated_at datetime [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    status
    user_id
  }
}

// ====== BẢNG THÔNG BÁO ======
Table notifications {
  id int [pk, increment]
  user_id int [not null, ref: > accounts.id]
  title varchar(255) [not null]
  message text
  type varchar(50) [not null]
  is_read boolean [default: false]
  created_at datetime [default: `CURRENT_TIMESTAMP`]
  data json
  read_at datetime
  
  indexes {
    is_read
    type
    user_id
  }
}

// ====== BẢNG TIN NHẮN ======
Table messages {
  id int [pk, increment]
  conversation_id int
  sender_id int [not null, ref: > accounts.id]
  receiver_id int [not null, ref: > accounts.id]
  message text [not null]
  status int [default: 0]
  created_at datetime [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    conversation_id
    receiver_id
    sender_id
  }
}

// ====== BẢNG TÀI NGUYÊN MEDIA ======
Table media_assets {
  id int [pk, increment]
  owner_type varchar(20) [not null]
  owner_id bigint [not null]
  context varchar(50) [not null]
  file_type varchar(20) [not null]
  mime_type varchar(100)
  original_filename varchar(255)
  url text [not null]
  preview_url text
  cdn_url text
  size bigint
  metadata json
  version int [default: 1]
  status varchar(20) [default: 'active']
  created_by int
  created_at datetime [default: `CURRENT_TIMESTAMP`]
  updated_at datetime [default: `CURRENT_TIMESTAMP`]
  deleted_at datetime
  expires_at datetime
  view_count int [default: 0]
  download_count int [default: 0]
  last_accessed_at datetime
  
  indexes {
    context
    created_by
    expires_at
    (owner_type, owner_id)
    status
  }
}

// ====== BẢNG IDE NỘI DUNG ======
Table content_ides {
  id int [pk, increment]
  user_id int [not null, ref: > accounts.id]
  content_id int [not null]
  language varchar(50) [not null]
  content text
  test_results json
  status int
  editor_config json
  created_at datetime [default: `CURRENT_TIMESTAMP`]
  updated_at datetime [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    content_id
    user_id
  }
}

// ====== BẢNG MẪU IDE KHỞI ĐẦU ======
Table content_ides_starter {
  id int [pk, increment]
  content_id int [not null]
  language varchar(50) [not null]
  content text
  description text
  created_at datetime [default: `CURRENT_TIMESTAMP`]
  updated_at datetime [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    content_id
    (content_id, language) [unique]
  }
}

// ====== BẢNG TEST CASES CHO IDE ======
Table content_ides_test_cases {
  id int [pk, increment]
  starter_id int [not null, ref: > content_ides_starter.id]
  test_name varchar(255) [not null]
  input text [not null, note: 'Input data for test case']
  expected_output text [not null, note: 'Expected output']
  is_hidden boolean [default: false, note: 'Hidden test cases for grading']
  points int [default: 1, note: 'Points awarded for passing']
  timeout_ms int [default: 5000, note: 'Execution timeout in milliseconds']
  order_index int [default: 0]
  created_at datetime [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    starter_id
    order_index
  }
}

// ====== BẢNG HỒ SƠ NGƯỜI DÙNG ======
Table user_profiles {
  id int [pk, increment]
  user_id int [unique, not null, ref: - accounts.id]
  bio text
  phone varchar(20)
  gender varchar(10)
  country varchar(100)
  language varchar(10) [default: 'vi']
  address text
  city varchar(100)
  created_at datetime [default: `CURRENT_TIMESTAMP`]
  date_of_birth date
  timezone varchar(50) [default: 'Asia/Ho_Chi_Minh']
  updated_at datetime [default: `CURRENT_TIMESTAMP`]
  website varchar(255)
  
  indexes {
    user_id
  }
}

// ====== BẢNG NHẬT KÝ KIỂM TOÁN ======
Table audit_logs {
  id int [pk, increment]
  user_id int
  action varchar(100) [not null]
  resource_type varchar(50) [not null]
  resource_id bigint
  old_values json
  new_values json
  ip_address varchar(45)
  user_agent text
  created_at datetime [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    action
    created_at
    (resource_type, resource_id)
    user_id
  }
}

// ====== BẢNG NHẬT KÝ HỆ THỐNG ======
Table system_logs {
  id int [pk, increment]
  level varchar(20) [not null]
  category varchar(50)
  message text [not null]
  context json
  created_at datetime [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    category
    created_at
    level
  }
}

// ====== BẢNG CÀI ĐẶT HỆ THỐNG ======
Table system_settings {
  id int [pk, increment]
  key varchar(100) [unique, not null]
  value text
  type varchar(20) [default: 'string']
  description text
  updated_at datetime [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    key
  }
}
